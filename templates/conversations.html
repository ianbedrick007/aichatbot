{% extends "base.html" %}

{% block title %}Conversations - WhatsApp{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='css/conversations.css') }}">
<style>
    :root {
        --wa-bg: #111b21;
        --wa-header: #202c33;
        --wa-border: #2a3942;
        --wa-incoming: #202c33;
        --wa-outgoing: #005c4b;
        --wa-primary: #00a884;
        --wa-text-main: #e9edef;
        --wa-text-sec: #8696a0;
        --wa-panel-bg: #111b21;
    }

    body.conversations-body {
        background-color: #090e11;
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: var(--wa-text-main);
    }

    .conversations-wrapper {
        display: flex;
        height: 100vh;
        width: 100%;
        overflow: hidden;
        background-color: var(--wa-bg);
        flex-direction: row;
    }

    /* --- Sidebar --- */
    .conversations-sidebar {
        width: 30%;
        min-width: 300px;
        max-width: 450px;
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--wa-border);
        background-color: var(--wa-bg);
        flex-shrink: 0;
    }

    .sidebar-header {
        height: 60px;
        background-color: var(--wa-header);
        padding: 10px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .customer-list {
        flex: 1;
        overflow-y: auto;
    }

    .customer-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid var(--wa-border);
        transition: background-color 0.2s;
    }

    .customer-item:hover {
        background-color: #202c33;
    }

    .customer-item.active {
        background-color: #2a3942;
    }

    .customer-avatar-small {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background-color: #6a7175;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 18px;
        color: white;
    }

    .customer-preview {
        flex: 1;
        overflow: hidden;
    }

    .customer-preview-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
    }

    .customer-preview-name {
        font-weight: 500;
        color: var(--wa-text-main);
    }

    .customer-preview-time {
        font-size: 12px;
        color: var(--wa-text-sec);
    }

    .customer-preview-message {
        color: var(--wa-text-sec);
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin: 0;
    }

    /* Ensure the main chat area is a flex column to push input to bottom */
    .conversation-detail {
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
        overflow: hidden;
        flex: 1;
        background-color: #0b141a;
        /* WhatsApp Dark Doodle Pattern */
        background-image: url("https://static.whatsapp.net/rsrc.php/v3/yl/r/gi_Dck48hVP.png");
        background-repeat: repeat;
        background-size: 400px;
    }

    .conversation-header {
        height: 60px;
        background-color: var(--wa-header);
        padding: 10px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 10;
    }

    /* Messages area takes available space and scrolls */
    .conversation-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px 5%;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .message-item {
        display: flex;
        margin-bottom: 8px;
        width: 100%;
    }

    .message-user {
        justify-content: flex-start;
    }

    .message-bot {
        justify-content: flex-end;
    }

    .message-bubble-glass {
        max-width: 65%;
        padding: 6px 7px 8px 9px;
        border-radius: 7.5px;
        position: relative;
        font-size: 14.2px;
        line-height: 19px;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
    }

    .message-user .message-bubble-glass {
        background-color: var(--wa-incoming);
        color: var(--wa-text-main);
        border-top-left-radius: 0;
    }

    .message-bot .message-bubble-glass {
        background-color: var(--wa-outgoing);
        color: var(--wa-text-main);
        border-top-right-radius: 0;
    }

    .message-time {
        font-size: 11px;
        color: #8696a0;
        /* Lighter gray for time */
        float: right;
        margin-left: 10px;
        margin-top: 4px;
        vertical-align: bottom;
    }

    /* Input area styling to match glass design */
    .chat-input-area {
        padding: 10px 16px;
        background: var(--wa-header);
        margin-top: auto;
        /* Push to bottom */
        min-height: 62px;
    }

    .chat-input-area .input-group {
        background: var(--wa-border);
        border-radius: 8px;
        padding: 5px 10px;
        border: none;
        display: flex;
        align-items: center;
        width: 100%;
    }

    .chat-input-area .form-control {
        border: none;
        background: transparent;
        box-shadow: none;
        padding-left: 10px;
        color: var(--wa-text-main);
        flex: 1;
    }

    .chat-input-area .form-control::placeholder {
        color: var(--wa-text-sec);
    }

    .chat-input-area .form-control:focus {
        box-shadow: none;
        background: transparent;
        color: var(--wa-text-main);
    }

    .chat-input-area .btn-send {
        background: transparent;
        border: none;
        color: var(--wa-text-sec);
        padding: 0;
        margin-left: 5px;
        font-size: 20px;
    }

    /* Header Icons */
    .icon-btn {
        color: var(--wa-text-sec);
        margin-left: 15px;
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
    }

    .header-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--wa-text-main);
        margin: 0;
    }

    .sidebar-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--wa-text-main);
        margin: 0;
    }
</style>
{% endblock %}

{% block body_class %}conversations-body{% endblock %}

{% block content %}
<div class="conversations-wrapper">
    <!-- Two Column Layout -->
    <!-- Left Sidebar - Customer List -->
    <aside class="conversations-sidebar">
        <div class="sidebar-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="customer-avatar-small" style="width: 40px; height: 40px; background: #00a884;">
                    <span>{{ business.name[0].upper() if business else 'W' }}</span>
                </div>
                <h2 class="sidebar-title">Chats</h2>
            </div>
            <div class="header-right">
                <button onclick="location.reload()" class="icon-btn" title="Refresh">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
                <a href="#" class="icon-btn" title="New Chat">
                    <i class="bi bi-chat-left-text-fill"></i>
                </a>
                <a href="#" class="icon-btn" title="Menu">
                    <i class="bi bi-three-dots-vertical"></i>
                </a>
            </div>
        </div>

        <!-- Search Bar Mockup -->
        <div style="padding: 8px 12px; border-bottom: 1px solid var(--wa-border);">
            <div
                style="background: var(--wa-header); border-radius: 8px; padding: 6px 12px; display: flex; align-items: center;">
                <i class="bi bi-search" style="color: var(--wa-text-sec); font-size: 14px; margin-right: 15px;"></i>
                <input type="text" placeholder="Search or start new chat"
                    style="background: transparent; border: none; color: white; width: 100%; outline: none; font-size: 14px;">
            </div>
        </div>

        <div class="customer-list" id="customerList">
            <!-- Loading state -->
            <div class="loading-state" style="padding: 20px; text-align: center; color: var(--wa-text-sec);">
                <i class="bi bi-hourglass-split"></i>
                <p>Loading chats...</p>
            </div>
        </div>
    </aside>

    <!-- Right Panel - Conversation Messages -->
    <main class="conversation-detail">
        <div class="empty-state-glass" id="emptyState"
            style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--wa-text-sec); border-bottom: 6px solid #00a884;">
            <i class="bi bi-whatsapp" style="font-size: 64px; margin-bottom: 20px; color: #3b4a54;"></i>
            <h2 style="color: var(--wa-text-main); font-weight: 300;">WhatsApp Web</h2>
            <p class="empty-text" style="font-size: 14px;">Send and receive messages without keeping your phone online.
            </p>
        </div>

        <!-- Conversation Header (hidden initially) -->
        <div class="conversation-header" id="conversationHeader" style="display: none;">
            <div class="customer-info" style="display: flex; align-items: center;">
                <div class="customer-avatar-small" style="margin-right: 15px;">
                    <span id="customerInitial">C</span>
                </div>
                <div>
                    <h3 class="customer-name" id="selectedCustomerName"
                        style="margin: 0; font-size: 16px; color: var(--wa-text-main);">Customer</h3>
                    <p class="customer-status" style="margin: 0; font-size: 12px; color: var(--wa-text-sec);">click here
                        for contact info</p>
                </div>
            </div>
            <div class="header-actions" style="display: flex; align-items: center;">
                <div class="form-check form-switch" style="margin-right: 15px;">
                    <input class="form-check-input" type="checkbox" id="aiToggle" checked onchange="handleAiToggle()">
                    <label class="form-check-label" for="aiToggle"
                        style="color: var(--wa-text-sec); font-size: 12px;">AI</label>
                </div>
                <i class="bi bi-search icon-btn"></i>
                <i class="bi bi-three-dots-vertical icon-btn"></i>
            </div>
        </div>

        <!-- Messages Area (hidden initially) -->
        <div class="conversation-messages" id="conversationMessages" style="display: none;">
            <!-- Messages will be loaded here -->
        </div>

        <!-- AI Off Message Input (Moved to bottom) -->
        <div id="aiOffMessageInput" class="chat-input-area" style="display: none;">
            <div class="input-group">
                <i class="bi bi-emoji-smile"
                    style="color: var(--wa-text-sec); font-size: 20px; margin-right: 10px; cursor: pointer;"></i>
                <i class="bi bi-paperclip"
                    style="color: var(--wa-text-sec); font-size: 20px; margin-right: 10px; cursor: pointer;"></i>
                <input type="text" class="form-control" id="manualMessage" placeholder="Type a message"
                    onkeypress="handleKeyPress(event)">
                <button class="btn-send" onclick="sendMessage()">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedCustomer = null;
    let customersData = {}; // Store customer data to access ai_enabled status

    // Load customer list on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadCustomers();
    });

    async function loadCustomers() {
        try {
            const response = await fetch('/api/customers');
            
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            
            const data = await response.json();

            // Check if data.customers exists before accessing length
            if (!data.customers) {
                throw new Error(data.detail || "Failed to load customers");
            }

            const customerList = document.getElementById('customerList');

            if (data.customers.length === 0) {
                customerList.innerHTML = `
                <div class="empty-state-glass">
                    <i class="bi bi-inbox" style="font-size: 32px; opacity: 0.5;"></i>
                    <p class="empty-text">No conversations yet</p>
                </div>
            `;
                return;
            }

            customerList.innerHTML = data.customers.map(customer => {
                // Store data for lookup later
                customersData[customer.id] = customer;
                return `
            <div class="customer-item" onclick="selectCustomer('${customer.id}', this)">
                <div class="customer-avatar-small">
                    <span>${customer.name[0].toUpperCase()}</span>
                </div>
                <div class="customer-preview">
                    <div class="customer-preview-header">
                        <span class="customer-preview-name">${customer.name}</span>
                        <span class="customer-preview-time">${customer.last_timestamp.split(' ')[1]}</span>
                    </div>
                    <p class="customer-preview-message">${customer.last_message}</p>
                    <span class="message-count-badge">${customer.message_count}</span>
                </div>
            </div>
        `;
            }).join('');

        } catch (error) {
            console.error('Error loading customers:', error);
            document.getElementById('customerList').innerHTML = `
            <div class="error-state">
                <i class="bi bi-exclamation-triangle"></i>
                <p>Failed to load customers</p>
            </div>
        `;
        }
    }

    async function selectCustomer(customerId, element) {
        selectedCustomer = customerId;
        const customer = customersData[customerId];

        // Update UI to show selected state
        document.querySelectorAll('.customer-item').forEach(item => {
            item.classList.remove('active');
        });
        if (element) {
            element.classList.add('active');
        }

        // Hide empty state, show conversation
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('conversationHeader').style.display = 'flex';
        document.getElementById('conversationMessages').style.display = 'flex';

        // Update header
        document.getElementById('selectedCustomerName').textContent = customer ? customer.name : customerId;
        document.getElementById('customerInitial').textContent = (customer ? customer.name : customerId)[0].toUpperCase();

        // Set toggle state based on stored customer data
        const toggle = document.getElementById('aiToggle');
        if (customer) {
            toggle.checked = customer.ai_enabled;

            // Show/Hide input based on AI status
            const messageInput = document.getElementById('aiOffMessageInput');
            messageInput.style.display = customer.ai_enabled ? 'none' : 'block';
        }

        // Load messages
        await loadMessages(customerId);
    }

    async function loadMessages(customerName) {
        try {
            const response = await fetch(`/api/customer-messages/${encodeURIComponent(customerName)}`);
            
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            
            const data = await response.json();

            const messagesContainer = document.getElementById('conversationMessages');

            if (data.messages.length === 0) {
                messagesContainer.innerHTML = `
                <div class="empty-state-glass">
                    <p class="empty-text">No messages yet</p>
                </div>
            `;
                return;
            }

            messagesContainer.innerHTML = data.messages.map(msg => `
            <div class="message-item ${msg.is_bot ? 'message-bot' : 'message-user'}">
                <div class="message-bubble-glass">
                    <p class="message-text">${msg.text}</p>
                    <span class="message-time">${msg.timestamp}</span>
                </div>
            </div>
        `).join('');

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

        } catch (error) {
            console.error('Error loading messages:', error);
            document.getElementById('conversationMessages').innerHTML = `
            <div class="error-state">
                <p>Failed to load messages</p>
            </div>
        `;
        }
    }

    function handleAiToggle() {
        const toggle = document.getElementById('aiToggle');
        const messageInput = document.getElementById('aiOffMessageInput');

        if (!toggle.checked) {
            // AI turned OFF
            // 1. Call API to disable AI immediately
            callToggleApi(false, null);
            // 2. Show input field
            messageInput.style.display = 'block';
            document.getElementById('manualMessage').focus();
        } else {
            // AI turned ON
            // 1. Call API to enable AI
            callToggleApi(true, null);
            // 2. Hide input field
            messageInput.style.display = 'none';
        }
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    async function sendMessage() {
        const messageInput = document.getElementById('manualMessage');
        const message = messageInput.value.trim();

        if (!message) return;

        // Clear input but keep it visible (since AI is still off)
        messageInput.value = '';

        await callToggleApi(false, message);
    }

    async function callToggleApi(enable, message) {
        try {
            const response = await fetch('/api/toggle-ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    customer_id: selectedCustomer,
                    enable_ai: enable,
                    message: message
                })
            });
            // Update local state
            if (customersData[selectedCustomer]) {
                customersData[selectedCustomer].ai_enabled = enable;
            }
            // Reload messages if a manual message was sent
            if (message) {
                await loadMessages(selectedCustomer);
            }
        } catch (error) {
            console.error('Error toggling AI:', error);
            alert('Failed to update AI status');
        }
    }
</script>
{% endblock %}